# Интеграция Mace Loyalty и корзины Tilda (t706)
Скрипт добавляет в стандартную корзину Tilda (t706) блок программы лояльности MaceLoyalty:
* автоматически находит номер телефона в форме заказа;
* по телефону запрашивает карту клиента через публичный API;
* показывает баланс и возможное начисление/списание бонусов или скидку по карте;
* записывает параметры карты в скрытые поля формы;
* применяет скидку/списание бонусов через встроенный механизм промокодов Tilda;
* учитывает выбранный способ оплаты и может скрывать блок лояльности для определённых вариантов оплаты (например, «наличными»).

## Настройка кода
Основные настройки задаются в объекте `MaceLoyaltySettings` в начале скрипта:
```
const DesignVariant = {
  BLUE: 'blue',
  GREY: 'grey',
  WHITE: 'white',
};

const MaceLoyaltySettings = {
  // ОБЯЗАТЕЛЬНО: id компании в Mace Loyalty
  clientId: '',

  // ОБЯЗАТЕЛЬНО: секрет для доступа к API
  secret: '',

  // ОБЯЗАТЕЛЬНО: URL оформления карты (куда отправляем клиента, если карты нет)
  cardIssueURL: '',

  // ОПЦИОНАЛЬНО: способы оплаты, при которых блок лояльности не отображается
  // Значения берутся из атрибутов value инпутов name="paymentsystem"
  // Пример: <input type="radio" name="paymentsystem" value="cash" ...>
  forbiddenPayment: ['cash'],

  // ОПЦИОНАЛЬНО: цветовая схема блока (BLUE | GREY | WHITE)
  designVariant: DesignVariant.BLUE,
};

const API_HOST = 'https://easy-cards.ru:8081/tilda/api/v1';
```

**Поля настроек**
* `clientId` *(обязательно)* — Идентификатор компании в MaceLoyalty. Выдаётся при подключении.

* `secret` *(обязательно)* — Секретный ключ для авторизации в API. Выдаётся при подключении.

* `cardIssueURL` *(обязательно)* — URL оформления карты лояльности. Выдаётся при подключении. Открывается в новой вкладке, если по номеру телефона карта не найдена и пользователь нажимает кнопку «Оформить карту».

* `forbiddenPayment` *(опционально)* — Массив системных кодов способов оплаты (значения атрибута value у `input[name="paymentsystem"]`), при которых блок лояльности скрывается, а карта не подгружается.

Примеры:

```
// Скрывать блок при оплате наличными
forbiddenPayment: ['cash']

// Скрывать блок при нале и банковском переводе
forbiddenPayment: ['cash', 'banktransfer']

// Не скрывать никогда (всегда показывать)
forbiddenPayment: []
```

* `designVariant` *(опционально)* — Управляет цветовой схемой и декором фона блока:
  - `DesignVariant.BLUE` — синяя тема (по умолчанию);
  - `DesignVariant.GREY` — светло-серая тема;
  - `DesignVariant.WHITE` — белая тема.

## Настройка Tilda
1. Для корректной работы кода, он должен быть размещен на всех страницах сайта. Код можно разместить в блоке HTML (`T123`) или внутри HEAD (**Настройки сайта -> Еще -> HTML-код для вставки внутрь HEAD**). Код размезаем между тегами `<script></script>`.
2. Переходим в настройки платежных систем (**Настройки сайта -> Платежные системы -> Общие настройки для платежных систем**) и в настройкам устанавливаем следующие настройки:
   * Уровень проверки товаров из блоков перед переходом к оплате: **Разрешать продавать товар без проверок**
   * Уровень проверки цены доставки: **Не проверять**
   * Уровень проверки скидки: **Не проверять**
