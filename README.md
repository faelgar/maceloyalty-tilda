# Интеграция Mace Loyalty и корзины Tilda (t706)
Скрипт добавляет в стандартную корзину Tilda (t706) блок программы лояльности MaceLoyalty:
* автоматически находит номер телефона в форме заказа;
* по телефону запрашивает карту клиента через публичный API;
* показывает баланс и возможное начисление/списание бонусов или скидку по карте;
* записывает параметры карты в скрытые поля формы;
* применяет скидку/списание бонусов через встроенный механизм промокодов Tilda;
* учитывает выбранный способ оплаты и может скрывать блок лояльности для определённых вариантов оплаты (например, «наличными»).

## Настройка кода
Основные настройки задаются в объекте `MaceLoyaltySettings` в начале скрипта:
```
const DesignVariant = {
  BLUE: 'blue',
  GREY: 'grey',
  WHITE: 'white',
};

const MaceLoyaltySettings = {
  // ОБЯЗАТЕЛЬНО: id компании в Mace Loyalty
  clientId: '',

  // ОБЯЗАТЕЛЬНО: секрет для доступа к API
  secret: '',

  // ОБЯЗАТЕЛЬНО: URL оформления карты (куда отправляем клиента, если карты нет)
  cardIssueURL: '',

  // ОПЦИОНАЛЬНО: способы оплаты, при которых блок лояльности не отображается
  // Значения берутся из атрибутов value инпутов name="paymentsystem"
  // Пример: <input type="radio" name="paymentsystem" value="cash" ...>
  forbiddenPayment: ['cash'],

  // ОПЦИОНАЛЬНО: цветовая схема блока (BLUE | GREY | WHITE)
  designVariant: DesignVariant.BLUE,
};

const API_HOST = 'https://easy-cards.ru:8081/tilda/api/v1';
```

**Поля настроек**
* `clientId` *(обязательно)* — Идентификатор компании в MaceLoyalty. Выдаётся при подключении.

* `secret` *(обязательно)* — Секретный ключ для авторизации в API. Выдаётся при подключении.

* `cardIssueURL` *(обязательно)* — URL оформления карты лояльности. Выдаётся при подключении. Открывается в новой вкладке, если по номеру телефона карта не найдена и пользователь нажимает кнопку «Оформить карту».

* `forbiddenPayment` *(опционально)* — Массив системных кодов способов оплаты (значения атрибута value у `input[name="paymentsystem"]`), при которых блок лояльности скрывается, а карта не подгружается.

Примеры:

```
// Скрывать блок при оплате наличными
forbiddenPayment: ['cash']

// Скрывать блок при нале и банковском переводе
forbiddenPayment: ['cash', 'banktransfer']

// Не скрывать никогда (всегда показывать)
forbiddenPayment: []
```

* `designVariant` *(опционально)* — Управляет цветовой схемой и декором фона блока:
  - `DesignVariant.BLUE` — синяя тема (по умолчанию);
  - `DesignVariant.GREY` — светло-серая тема;
  - `DesignVariant.WHITE` — белая тема.

## Настройка Tilda
1. Для корректной работы кода, он должен быть размещен на всех страницах сайта. Код можно разместить в блоке HTML (`T123`) или внутри HEAD (**Настройки сайта -> Еще -> HTML-код для вставки внутрь HEAD**). Код размещаем между тегами `<script></script>`.

2. Переходим в настройки платежных систем (**Настройки сайта -> Платежные системы -> Общие настройки для платежных систем**)

![Находим в разделе "Платежные системы" Общие настройки для платежных систем](https://github.com/faelgar/maceloyalty-tilda/blob/c7ba24f28d045706721306ac3f60880a98732c28/screenshots/ml_01.png)

и в настройках устанавливаем следующие параметры:
   * Уровень проверки товаров из блоков перед переходом к оплате: **Разрешать продавать товар без проверок**
   * Уровень проверки цены доставки: **Не проверять**
   * Уровень проверки скидки: **Не проверять**

![Настройки внутри раздела Общие настройки платежных систем](https://github.com/faelgar/maceloyalty-tilda/blob/c7ba24f28d045706721306ac3f60880a98732c28/screenshots/ml_02.png)

3. После этого переходим обратно в платежные системы в раздел **Промокоды**

![Переходим в раздел "Промокоды"](https://github.com/faelgar/maceloyalty-tilda/blob/320f742e8f076d86cecb441900891e6f060fd8ab/screenshots/ml_03.png)

и создаем промокод `PERSONALCODE` со следующими параметрами:
  * Промокод: **PERSONALCODE**
  * Скидка: **1**
  * Количество: _поле оставляем пустым_
  * Срок действия: _поле оставляем пустым_
  * Описание: любой комментарий, который напомнит вам, что этот промокод нельзя удалять или менять

> [!IMPORTANT]
> **Этот шаг очень важен, т.к. без него код не будет работать. Этот промокод будет использоваться автоматически при использовании карты и его значение будет автоматически меняться в зависимости от суммы, которую спишет клиент или процента его скидки.**

![Создаем новый промокод](https://github.com/faelgar/maceloyalty-tilda/blob/320f742e8f076d86cecb441900891e6f060fd8ab/screenshots/ml_04.png)
